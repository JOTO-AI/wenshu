name: Deploy to Internal Network

on:
  push:
    branches:
      - main
      - release/*
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Cache Docker layers
        uses: actions/cache@v4
        with:
          path: /tmp/.buildx-cache
          key: ${{ runner.os }}-buildx-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-buildx-

      # å®‰è£…OpenConnect VPNå®¢æˆ·ç«¯
      - name: Install OpenConnect
        run: |
          sudo apt-get update
          sudo apt-get install -y openconnect

      # åˆ›å»ºVPNé…ç½®æ–‡ä»¶
      - name: Setup VPN configuration
        run: |
          echo "${{ secrets.VPN_PASSWORD }}" | sudo openconnect \
            --background \
            --pid-file=/var/run/openconnect.pid \
            --user="${{ secrets.VPN_USERNAME }}" \
            --passwd-on-stdin \
            --servercert="${{ secrets.VPN_SERVER_CERT }}" \
            --script=/etc/vpnc/vpnc-script \
            "${{ secrets.VPN_SERVER }}"

          # ç­‰å¾…VPNè¿žæŽ¥å»ºç«‹
          sleep 10

          # éªŒè¯VPNè¿žæŽ¥
          if ! ping -c 3 "${{ secrets.DEPLOY_HOST }}"; then
            echo "VPNè¿žæŽ¥å¤±è´¥ï¼Œæ— æ³•è®¿é—®å†…ç½‘æœåŠ¡å™¨"
            exit 1
          fi

      # æž„å»ºDockeré•œåƒ
      - name: Build Docker images
        run: |
          # æž„å»ºAPIé•œåƒ
          docker build \
            --cache-from=type=local,src=/tmp/.buildx-cache \
            --cache-to=type=local,dest=/tmp/.buildx-cache-new,mode=max \
            -t wenshu-api:${{ github.sha }} \
            -t wenshu-api:latest \
            ./apps/api

          # æž„å»ºWebé•œåƒ
          docker build \
            --cache-from=type=local,src=/tmp/.buildx-cache \
            --cache-to=type=local,dest=/tmp/.buildx-cache-new,mode=max \
            -t wenshu-web:${{ github.sha }} \
            -t wenshu-web:latest \
            -f ./apps/web-app/Dockerfile \
            .

      # ä¿å­˜é•œåƒåˆ°taræ–‡ä»¶
      - name: Save Docker images
        run: |
          docker save wenshu-api:latest | gzip > wenshu-api.tar.gz
          docker save wenshu-web:latest | gzip > wenshu-web.tar.gz

      # å®‰è£…sshpasså¹¶è®¾ç½®SSHé…ç½®
      - name: Setup SSH with password
        run: |
          sudo apt-get update
          sudo apt-get install -y sshpass
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts

          # è®¾ç½®SSHé…ç½®ï¼Œç¦ç”¨å¯†é’¥è®¤è¯ï¼Œå¯ç”¨å¯†ç è®¤è¯
          cat > ~/.ssh/config << EOF
          Host ${{ secrets.DEPLOY_HOST }}
            HostName ${{ secrets.DEPLOY_HOST }}
            User ${{ secrets.DEPLOY_USER }}
            PreferredAuthentications password
            PubkeyAuthentication no
            PasswordAuthentication yes
            StrictHostKeyChecking no
          EOF
          chmod 600 ~/.ssh/config

      # ä¼ è¾“æ–‡ä»¶åˆ°ç›®æ ‡æœåŠ¡å™¨
      - name: Transfer files to server
        run: |
          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          sshpass -p "${{ secrets.DEPLOY_PASSWORD }}" ssh "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" \
            "sudo mkdir -p ${{ secrets.DEPLOY_PATH }}"

          # ä¼ è¾“Dockeré•œåƒ
          sshpass -p "${{ secrets.DEPLOY_PASSWORD }}" scp wenshu-api.tar.gz wenshu-web.tar.gz \
            "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}/"

          # ä¼ è¾“Docker Composeé…ç½®
          sshpass -p "${{ secrets.DEPLOY_PASSWORD }}" scp docker-compose.yml docker.env.example \
            "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}/"

          # ä¼ è¾“éƒ¨ç½²è„šæœ¬
          sshpass -p "${{ secrets.DEPLOY_PASSWORD }}" scp scripts/deploy.sh \
            "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}/"

      # åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šéƒ¨ç½²
      - name: Deploy on target server
        run: |
          sshpass -p "${{ secrets.DEPLOY_PASSWORD }}" ssh "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" << 'EOF'
            cd ${{ secrets.DEPLOY_PATH }}

            # åŠ è½½Dockeré•œåƒ
            docker load < wenshu-api.tar.gz
            docker load < wenshu-web.tar.gz

            # è®¾ç½®çŽ¯å¢ƒå˜é‡
            if [ ! -f .env ]; then
              cp docker.env.example .env
            fi

            # å¤‡ä»½å½“å‰è¿è¡Œçš„å®¹å™¨ï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
            if docker-compose ps | grep -q "Up"; then
              docker-compose down --remove-orphans
            fi

            # å¯åŠ¨æ–°çš„å®¹å™¨
            docker-compose up -d

            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            sleep 30

            # å¥åº·æ£€æŸ¥
            if ! curl -f http://localhost:8000/health; then
              echo "APIå¥åº·æ£€æŸ¥å¤±è´¥"
              exit 1
            fi

            if ! curl -f http://localhost:80/health; then
              echo "Webå¥åº·æ£€æŸ¥å¤±è´¥"
              exit 1
            fi

            echo "éƒ¨ç½²æˆåŠŸï¼"

            # æ¸…ç†æ—§é•œåƒï¼ˆä¿ç•™æœ€æ–°çš„ä¸¤ä¸ªç‰ˆæœ¬ï¼‰
            docker image prune -f

            # æ˜¾ç¤ºè¿è¡ŒçŠ¶æ€
            docker-compose ps
          EOF

      # æ–­å¼€VPNè¿žæŽ¥
      - name: Disconnect VPN
        if: always()
        run: |
          if [ -f /var/run/openconnect.pid ]; then
            sudo kill $(cat /var/run/openconnect.pid) || true
          fi

      # æ¸…ç†æž„å»ºç¼“å­˜
      - name: Move cache
        run: |
          rm -rf /tmp/.buildx-cache
          mv /tmp/.buildx-cache-new /tmp/.buildx-cache

      # å‘é€éƒ¨ç½²é€šçŸ¥ï¼ˆå¯é€‰ï¼‰
      - name: Send deployment notification
        if: always()
        run: |
          if [ "${{ job.status }}" == "success" ]; then
            echo "ðŸš€ éƒ¨ç½²æˆåŠŸåˆ°å†…ç½‘çŽ¯å¢ƒ: ${{ github.event.inputs.environment || 'staging' }}"
          else
            echo "âŒ éƒ¨ç½²å¤±è´¥: ${{ github.event.inputs.environment || 'staging' }}"
          fi
          # è¿™é‡Œå¯ä»¥æ·»åŠ å‘é€åˆ°Slackã€é‚®ä»¶æˆ–å…¶ä»–é€šçŸ¥æ¸ é“çš„ä»£ç 
