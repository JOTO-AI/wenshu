name: Deploy to Internal Network

on:
  push:
    branches:
      - main
      - release/*
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

env:
  DOCKER_BUILDKIT: 1
  COMPOSE_DOCKER_CLI_BUILD: 1

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      # ç¬¬ä¸€é˜¶æ®µï¼šæ„å»ºDockeré•œåƒï¼ˆVPNè¿æ¥å‰ï¼Œé¿å…ç½‘ç»œè·¯ç”±é—®é¢˜ï¼‰
      - name: Build Docker images
        run: |
          echo "ğŸ—ï¸ æ„å»ºDockeré•œåƒï¼ˆVPNè¿æ¥å‰ï¼‰"

          # æ„å»ºAPIé•œåƒ
          docker buildx build \
            --platform linux/amd64 \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            -t wenshu-api:${{ github.sha }} \
            -t wenshu-api:latest \
            --load \
            ./apps/api

          # æ„å»ºWebé•œåƒ
          docker buildx build \
            --platform linux/amd64 \
            --cache-from type=gha \
            --cache-to type=gha,mode=max \
            -t wenshu-web:${{ github.sha }} \
            -t wenshu-web:latest \
            --load \
            -f ./apps/web-app/Dockerfile \
            .

          echo "âœ… Dockeré•œåƒæ„å»ºå®Œæˆ"

      # ä¿å­˜é•œåƒåˆ°taræ–‡ä»¶
      - name: Save Docker images
        run: |
          echo "ğŸ“¦ ä¿å­˜Dockeré•œåƒåˆ°æ–‡ä»¶"
          docker save wenshu-api:latest | gzip > wenshu-api.tar.gz
          docker save wenshu-web:latest | gzip > wenshu-web.tar.gz

          # æ˜¾ç¤ºæ–‡ä»¶å¤§å°
          ls -lh *.tar.gz
          echo "âœ… é•œåƒä¿å­˜å®Œæˆ"

      # ç¬¬äºŒé˜¶æ®µï¼šå®‰è£…å¿…è¦å·¥å…·
      - name: Install required tools
        run: |
          echo "ğŸ”§ å®‰è£…OpenConnect VPNå®¢æˆ·ç«¯å’Œç›¸å…³å·¥å…·"
          sudo apt-get update
          sudo apt-get install -y openconnect vpnc-scripts sshpass curl

          # ç¡®ä¿vpnc-scriptå­˜åœ¨å¹¶å¯æ‰§è¡Œ
          if [ ! -f /etc/vpnc/vpnc-script ]; then
            sudo mkdir -p /etc/vpnc
            sudo ln -sf /usr/share/vpnc-scripts/vpnc-script /etc/vpnc/vpnc-script
          fi
          sudo chmod +x /etc/vpnc/vpnc-script
          echo "âœ… å·¥å…·å®‰è£…å®Œæˆ"

      # ç¬¬ä¸‰é˜¶æ®µï¼šè¿æ¥VPN
      - name: Connect to VPN
        run: |
          echo "ğŸŒ è¿æ¥VPNåˆ°å†…ç½‘"
          echo "${{ secrets.VPN_PASSWORD }}" | sudo openconnect \
            --background \
            --pid-file=/var/run/openconnect.pid \
            --user="${{ secrets.VPN_USERNAME }}" \
            --passwd-on-stdin \
            --servercert="${{ secrets.VPN_SERVER_CERT }}" \
            --script=/etc/vpnc/vpnc-script \
            "${{ secrets.VPN_SERVER }}"

          # ç­‰å¾…VPNè¿æ¥å»ºç«‹
          echo "â³ ç­‰å¾…VPNè¿æ¥å»ºç«‹..."
          sleep 15

          # éªŒè¯VPNè¿æ¥
          echo "ğŸ” éªŒè¯VPNè¿æ¥"
          for i in {1..3}; do
            if ping -c 1 "${{ secrets.DEPLOY_HOST }}" > /dev/null 2>&1; then
              echo "âœ… VPNè¿æ¥æˆåŠŸï¼Œå¯ä»¥è®¿é—®å†…ç½‘æœåŠ¡å™¨"
              break
            else
              echo "âš ï¸ ç¬¬${i}æ¬¡pingå¤±è´¥ï¼Œé‡è¯•..."
              sleep 5
            fi

            if [ $i -eq 3 ]; then
              echo "âŒ VPNè¿æ¥å¤±è´¥ï¼Œæ— æ³•è®¿é—®å†…ç½‘æœåŠ¡å™¨"
              exit 1
            fi
          done

      # ç¬¬å››é˜¶æ®µï¼šè®¾ç½®SSH
      - name: Setup SSH configuration
        run: |
          echo "ğŸ”‘ é…ç½®SSHè¿æ¥"
          mkdir -p ~/.ssh
          ssh-keyscan -H "${{ secrets.DEPLOY_HOST }}" >> ~/.ssh/known_hosts

          # è®¾ç½®SSHé…ç½®ï¼Œä½¿ç”¨å¯†ç è®¤è¯
          cat > ~/.ssh/config << EOF
          Host ${{ secrets.DEPLOY_HOST }}
            HostName ${{ secrets.DEPLOY_HOST }}
            User ${{ secrets.DEPLOY_USER }}
            PreferredAuthentications password
            PubkeyAuthentication no
            PasswordAuthentication yes
            StrictHostKeyChecking no
            ConnectTimeout 30
          EOF
          chmod 600 ~/.ssh/config
          echo "âœ… SSHé…ç½®å®Œæˆ"

      # ç¬¬äº”é˜¶æ®µï¼šä¼ è¾“æ–‡ä»¶
      - name: Transfer files to server
        run: |
          echo "ğŸ“¤ ä¼ è¾“æ–‡ä»¶åˆ°ç›®æ ‡æœåŠ¡å™¨"

          # åˆ›å»ºéƒ¨ç½²ç›®å½•
          sshpass -p "${{ secrets.DEPLOY_PASSWORD }}" ssh "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" \
            "mkdir -p ${{ secrets.DEPLOY_PATH }}"

          # ä¼ è¾“Dockeré•œåƒï¼ˆä½¿ç”¨-væ˜¾ç¤ºè¿›åº¦ï¼‰
          echo "ğŸ“¦ ä¼ è¾“Dockeré•œåƒ..."
          sshpass -p "${{ secrets.DEPLOY_PASSWORD }}" scp -v wenshu-api.tar.gz wenshu-web.tar.gz \
            "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}/"

          # ä¼ è¾“é…ç½®æ–‡ä»¶
          echo "ğŸ“„ ä¼ è¾“é…ç½®æ–‡ä»¶..."
          sshpass -p "${{ secrets.DEPLOY_PASSWORD }}" scp -v docker-compose.yml docker-compose.prod.yml docker.env.example \
            "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}/"

          # ä¼ è¾“éƒ¨ç½²è„šæœ¬
          echo "ğŸ“œ ä¼ è¾“éƒ¨ç½²è„šæœ¬..."
          sshpass -p "${{ secrets.DEPLOY_PASSWORD }}" scp -v scripts/deploy.sh \
            "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}:${{ secrets.DEPLOY_PATH }}/"

          echo "âœ… æ–‡ä»¶ä¼ è¾“å®Œæˆ"

      # ç¬¬å…­é˜¶æ®µï¼šæ‰§è¡Œéƒ¨ç½²
      - name: Deploy on target server
        run: |
          echo "ğŸš€ åœ¨ç›®æ ‡æœåŠ¡å™¨ä¸Šæ‰§è¡Œéƒ¨ç½²"
          sshpass -p "${{ secrets.DEPLOY_PASSWORD }}" ssh "${{ secrets.DEPLOY_USER }}@${{ secrets.DEPLOY_HOST }}" << 'EOF'
            set -e
            cd ${{ secrets.DEPLOY_PATH }}

            echo "ğŸ“ å½“å‰ç›®å½•: $(pwd)"
            echo "ğŸ“‚ æ–‡ä»¶åˆ—è¡¨:"
            ls -la

            # åŠ è½½Dockeré•œåƒ
            echo "ğŸ“¥ åŠ è½½Dockeré•œåƒ..."
            docker load < wenshu-api.tar.gz
            docker load < wenshu-web.tar.gz

            # è®¾ç½®ç¯å¢ƒå˜é‡
            if [ ! -f .env ]; then
              echo "âš™ï¸ åˆ›å»ºç¯å¢ƒé…ç½®æ–‡ä»¶..."
              cp docker.env.example .env
            fi

            # å¤‡ä»½å½“å‰è¿è¡Œçš„å®¹å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if docker compose ps 2>/dev/null | grep -q "Up"; then
              echo "ğŸ”„ åœæ­¢ç°æœ‰å®¹å™¨..."
              docker compose down --remove-orphans
            fi

            # å¯åŠ¨æ–°çš„å®¹å™¨
            echo "ğŸš€ å¯åŠ¨å®¹å™¨..."
            docker compose up -d

            # ç­‰å¾…æœåŠ¡å¯åŠ¨
            echo "â³ ç­‰å¾…æœåŠ¡å¯åŠ¨..."
            sleep 30

            # å¥åº·æ£€æŸ¥
            echo "ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."

            # æ£€æŸ¥APIå¥åº·çŠ¶æ€
            if curl -f http://localhost:8000/health; then
              echo "âœ… APIå¥åº·æ£€æŸ¥é€šè¿‡"
            else
              echo "âŒ APIå¥åº·æ£€æŸ¥å¤±è´¥"
              docker compose logs api
              exit 1
            fi

            # æ£€æŸ¥Webå¥åº·çŠ¶æ€
            if curl -f http://localhost:80/health; then
              echo "âœ… Webå¥åº·æ£€æŸ¥é€šè¿‡"
            else
              echo "âŒ Webå¥åº·æ£€æŸ¥å¤±è´¥"
              docker compose logs web
              exit 1
            fi

            echo "ğŸ‰ éƒ¨ç½²æˆåŠŸï¼"

            # æ¸…ç†æ—§é•œåƒï¼ˆä¿ç•™æœ€æ–°çš„ä¸¤ä¸ªç‰ˆæœ¬ï¼‰
            echo "ğŸ§¹ æ¸…ç†æ—§èµ„æº..."
            docker image prune -f

            # æ˜¾ç¤ºè¿è¡ŒçŠ¶æ€
            echo "ğŸ“Š å®¹å™¨è¿è¡ŒçŠ¶æ€:"
            docker compose ps

            echo "ğŸŒ æœåŠ¡è®¿é—®åœ°å€:"
            echo "  - API: http://localhost:8000"
            echo "  - Web: http://localhost:80"
          EOF

      # ç¬¬ä¸ƒé˜¶æ®µï¼šæ–­å¼€VPNè¿æ¥
      - name: Disconnect VPN
        if: always()
        run: |
          echo "ğŸ”Œ æ–­å¼€VPNè¿æ¥"
          if [ -f /var/run/openconnect.pid ]; then
            sudo kill $(cat /var/run/openconnect.pid) || true
            echo "âœ… VPNè¿æ¥å·²æ–­å¼€"
          else
            echo "â„¹ï¸ æœªæ‰¾åˆ°VPNè¿›ç¨‹"
          fi

      # ç¬¬å…«é˜¶æ®µï¼šéƒ¨ç½²å®Œæˆé€šçŸ¥
      - name: Deployment completed
        if: success()
        run: |
          echo "ğŸš€ éƒ¨ç½²æˆåŠŸåˆ°å†…ç½‘ç¯å¢ƒ: ${{ github.event.inputs.environment || 'staging' }}"
          echo "âœ… æ‰€æœ‰æœåŠ¡æ­£å¸¸è¿è¡Œ"

      - name: Deployment failed
        if: failure()
        run: |
          echo "âŒ éƒ¨ç½²å¤±è´¥: ${{ github.event.inputs.environment || 'staging' }}"
          echo "ğŸ” è¯·æ£€æŸ¥ä¸Šè¿°æ—¥å¿—ä¿¡æ¯"
          exit 1
